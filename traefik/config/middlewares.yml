# Traefik Dynamic Configuration - Middlewares

http:
  middlewares:
    # Security Headers Middleware
    security-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 63072000
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Robots-Tag: "none,noarchive,nosnippet,notranslate,noimageindex"
          X-Forwarded-Proto: "https"
          Server: ""  # Hide server header

    # Rate Limiting Middleware
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1m

    # Rate Limit for API
    api-rate-limit:
      rateLimit:
        average: 10
        burst: 20
        period: 1m

    # IP Whitelist for Internal Networks
    internal-only:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "192.168.0.0/16"
          - "172.16.0.0/12"
          - "10.0.0.0/8"

    # Compress Responses
    compress:
      compress:
        excludedContentTypes:
          - text/event-stream

    # Authentik Forward Auth
    authentik:
      forwardAuth:
        address: "http://authentik-server:9000/outpost.goauthentik.io/auth/traefik"
        trustForwardHeader: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

    # Basic Authentication (Example)
    basic-auth:
      basicAuth:
        realm: "Restricted Area"
        # Users format: username:hashed_password
        # Generate with: htpasswd -nb username password
        users:
          - "admin:$2y$10$..."  # Replace with actual hashed password

    # Redirect Regex
    redirect-regex:
      redirectRegex:
        regex: "^https?://www.(.*)"
        replacement: "https://${1}"
        permanent: true

    # Add Prefix
    add-prefix:
      addPrefix:
        prefix: "/api"

    # Strip Prefix
    strip-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # CORS Headers
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
        accessControlAllowOriginList:
          - "https://*.example.com"
        accessControlMaxAge: 100
        addVaryHeader: true
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - "*"

    # Chain Multiple Middlewares
    secure-chain:
      chain:
        middlewares:
          - security-headers
          - rate-limit
          - compress